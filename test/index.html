<html>
<head>
  <meta charset="utf-8">
  <title>Mocha Tests</title>
  <link href="/node_modules/mocha/mocha.css" rel="stylesheet" />
</head>
<body>
  <div id="mocha"></div>

  <script src="/node_modules/mocha/mocha.js"></script>
  <script src="/node_modules/chai/chai.js"></script>
  <script src="/node_modules/lunr/lunr.js"></script>
  <script>
    mocha.setup('tdd')
    window.assert = chai.assert

    window.withFixture = function (name, fn) {
      var fixturePath = '/fixtures/' + name,
          xhr = new XMLHttpRequest

      xhr.addEventListener('load', function () {
        if (this.status != 200) {
          fn('non 200 response')
        } else {
          fn(null, this.responseText)
        }
      })

      xhr.open('GET', fixturePath)
      xhr.send()
    }
  </script>
  <script type="module">
    globalThis.upstreamLunr = globalThis.lunr

    import lunr from '/lunr.mjs';

    globalThis.lunr = lunr;

    const pending = [];

    for (
      const src of (
        await (await fetch('/env/file_list.json')).json()
      ).test_files
        .filter((maybe) => /^[a-z][a-z_]+\.js$/.test(maybe))
    ) {
      const script = document.createElement('script');
      script.src = src;
      pending.push(new Promise((yup, nope) => {
        script.onload = yup;
        script.onerror = nope;
      }))
      document.body.append(script);
    }

    await Promise.all(pending)

    mocha.checkLeaks();
    mocha.globals(['lunr']);
    mocha.run();
  </script>
</body>
</html>
